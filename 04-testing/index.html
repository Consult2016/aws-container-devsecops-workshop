



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="This workshop is designed to help attendees understand the security concerns of container images and learn how to create a devsecops pipeline for securely building and releasing images.">
      
      
        <link rel="canonical" href="https://container-devsecops.awssecworkshops.com/04-testing/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Module 4: Pipeline Testing - Integrating security into your container pipeline</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#module-4-pipeline-testing" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Integrating security into your container pipeline
                </span>
                <span class="md-header-nav__topic">
                  Module 4: Pipeline Testing
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/aws-container-devsecops-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-container-devsecops-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link md-tabs__link--active">
        Overview
      </a>
    
  </li>

      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://container-devsecops.awssecworkshops.com/"
        title="Integrating security into your container pipeline" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Container DevSecOps
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/aws-container-devsecops-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-container-devsecops-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../00-env-setup/" title="Module 0: Environment Setup" class="md-nav__link">
      Module 0: Environment Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-linting/" title="Module 1: Dockerfile Linting" class="md-nav__link">
      Module 1: Dockerfile Linting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-secrets-scanning/" title="Module 2: Secrets Scanning" class="md-nav__link">
      Module 2: Secrets Scanning
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-vuln-scanning/" title="Module 3: Vulnerability Scanning" class="md-nav__link">
      Module 3: Vulnerability Scanning
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 4: Pipeline Testing
      </label>
    
    <a href="./" title="Module 4: Pipeline Testing" class="md-nav__link md-nav__link--active">
      Module 4: Pipeline Testing
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-architecture" title="Pipeline Architecture" class="md-nav__link">
    Pipeline Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-commit" title="Make a commit" class="md-nav__link">
    Make a commit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-pull-request" title="Create a Pull Request" class="md-nav__link">
    Create a Pull Request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-feedback-loop" title="View the feedback loop" class="md-nav__link">
    View the feedback loop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-1-fix-the-dockerfile-linting-defects" title="Stage 1: Fix the Dockerfile linting defects" class="md-nav__link">
    Stage 1: Fix the Dockerfile linting defects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-2-remove-secrets" title="Stage 2: Remove secrets" class="md-nav__link">
    Stage 2: Remove secrets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-3-vulnerability-scanning-stage" title="Stage 3: Vulnerability Scanning Stage" class="md-nav__link">
    Stage 3: Vulnerability Scanning Stage
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../05-cleanup/" title="Module 5: Cleanup" class="md-nav__link">
      Module 5: Cleanup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipeline-architecture" title="Pipeline Architecture" class="md-nav__link">
    Pipeline Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-a-commit" title="Make a commit" class="md-nav__link">
    Make a commit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-pull-request" title="Create a Pull Request" class="md-nav__link">
    Create a Pull Request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-feedback-loop" title="View the feedback loop" class="md-nav__link">
    View the feedback loop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-1-fix-the-dockerfile-linting-defects" title="Stage 1: Fix the Dockerfile linting defects" class="md-nav__link">
    Stage 1: Fix the Dockerfile linting defects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-2-remove-secrets" title="Stage 2: Remove secrets" class="md-nav__link">
    Stage 2: Remove secrets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stage-3-vulnerability-scanning-stage" title="Stage 3: Vulnerability Scanning Stage" class="md-nav__link">
    Stage 3: Vulnerability Scanning Stage
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-container-devsecops-workshop/edit/master/docs/04-testing.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="module-4-pipeline-testing">Module 4 <small>Pipeline Testing</small></h1>
<p><strong>Time</strong>: 30 minutes</p>
<p>Now that you have integrated multiple types of security testing into your pipeline you can test it to ensure your stages are effective in properly evaluating the security of your container-based applications.  While going through each stage you will fix any misconfiguration or vulnerability so that your sample application is able to successfully passes through each stage and is pushed to AWS ECR.</p>
<h2 id="pipeline-architecture">Pipeline Architecture</h2>
<p><img alt="Architecture" src="../images/04-final-arch.png" title="Pipeline Architecture" /></p>
<ol>
<li><strong>Commit</strong>: Developer makes a commit to the <em>Development</em> branch.</li>
<li><strong>Pull Request</strong>: Developer makes a Pull Request<ul>
<li>Source Branch: <em>Developement</em></li>
<li>Destination Branch: <em>Master</em></li>
</ul>
</li>
<li><strong>Triggers Rule</strong>: A CloudWatch Event Rule is triggered based on the following events:<ul>
<li><em>pullRequestSourceBranchUpdated</em></li>
<li><em>pullRequestCreated</em></li>
</ul>
</li>
<li><strong>Starts CodePipeline</strong>: The AWS CodePipeline is setup as a target for the CloudWatch Event Rule and it is started after the CloudWatch Event Rule is triggered</li>
<li><strong>Pull Request Stage</strong>: The stage pulls in these sources and stores them as artifacts in S3;<ul>
<li>CodeCommit repository: <em>container-devsecops-wksp-app (development branch)</em></li>
<li>CodeCommit repository: <em>container-devsecops-wksp-config (master branch)</em></li>
</ul>
</li>
<li><strong>Dockerfile Linting Stage</strong>: The stage pulls in the artifacts from S3 and uses Hadolint (build spec file and configuration file pulled in from S3) to lint the Dockerfile to ensure it adheres to best practices.</li>
<li><strong>Secrets Scanning Stage</strong>: The stage runs high signal regex checks directly against the CodeCommit Repository (<em>container-devsecops-wksp-app - development branch</em>)</li>
<li><strong>Vulnerability Scanning Stage</strong>: The stage builds the container image, pushes it to ECR, and triggers an Anchore vulnerability assessment against the image.  If the scan results include any vulnerabilites that meet or exceed the threshold the build fails.  If the vulnerabilites are lower than the threshold the CodeBuild project will invoke a Lambda function with the scan results as the payload and the Lambda function will push the vulnerabilites into AWS Security Hub for future triaging since the risk for those have been accepted.</li>
<li><strong>Publish Imaeg</strong>: The last stage builds the image using the destination commit hash as the tag and publishes it to AWS ECR.</li>
<li><strong>CodeBuild Triggers</strong>: If any CodeBuild Project fails a CloudWatch Event Rule is triggered.</li>
<li><strong>Triggers Lambda Function</strong>: The Lambda Function is setup as a target for the CloudWatch Event Rule and is invoked after the CloudWatch Event Rule is triggered.</li>
<li><strong>Adds Feedback to Pull Request</strong>:  The Lambda Function takes the results from each stage and CodeBuild project and posts a comment back to the Pull Requst.  This gives the developers fast feedback so they're able to fix any issues that are identified through the pipeline.</li>
</ol>
<h2 id="make-a-commit">Make a commit</h2>
<p>Now you can test your pipeline to see how your Pull Requests result with an image being built and pushed to AWS ECR. First, make a commit to the <em>development branch</em> of your sample application</p>
<ol>
<li>Within your Cloud9 IDE expand your <strong>sample application</strong> on the left side.</li>
<li>Open the <strong>Dockerfile</strong>.</li>
<li>Add a name to the Label line.</li>
<li>Push your commit.</li>
</ol>
<div class="codehilite"><pre><span></span>    cd /home/ec2-user/environment/sample-application
    git add Dockerfile
    git commit -m &quot;Modified Maintainer in Dockerfile&quot;
    git push -u origin development
</pre></div>


<h2 id="create-a-pull-request">Create a Pull Request</h2>
<div class="codehilite"><pre><span></span>aws codecommit create-pull-request \
    --title &quot;Updated Maintainer&quot; \
    --description &quot;Please review these changes.&quot; \
    --targets repositoryName=container-devsecops-wksp-app,sourceReference=development,destinationReference=master
</pre></div>


<p>Go to your <a href="https://us-east-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/container-devsecops-wksp-pipeline/view" target="_blank">AWS CodePipeline</a> to view the progress and result.</p>
<h2 id="view-the-feedback-loop">View the feedback loop</h2>
<p>Each time a stage is run the results of the CodeBuild Project are posted back to the Pull Request to act as a feedback loop for developers.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=OPEN" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
</ol>
<h2 id="stage-1-fix-the-dockerfile-linting-defects">Stage 1: Fix the Dockerfile linting defects</h2>
<p>In the feedback you should see multiple defects that were identified by the Dockerfile linting stage.  The first defect can be fixed by modifying the hadolint configuration.</p>
<ol>
<li>
<p>Click on your Cloud9 IDE tab.</p>
</li>
<li>
<p>In the left file tree, expand the <strong>container-devsecops-wksp-config</strong> folder and open <strong>hadolint.yml</strong>.</p>
</li>
<li>
<p>Fix the defect:</p>
<div class="admonition info">
<p class="admonition-title"><strong>DL3026</strong>: Use only an allowed registry in the FROM image</p>
<p><strong>Description</strong>:  Using externally provided images can result in the same types of risks that external software traditionally has, such as introducing malware, leaking data, or including components with vulnerabilities. To prevent the use of externally provided images you should only pull images from trusted registries.</p>
<p><strong>Fix</strong>: Add <code>- docker.io</code> under <strong><em>trustedRegistries</em></strong>.  </p>
<p><strong>Explanation</strong>:  Since the image is pulling from Dockerhub we can include it on the list so that the build is able to pass.  Adding Dockerhub is purely for testing purposes, in reality you would whitelist trusted registries that you host yourself or registries hosted by trusted 3rd parties.</p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST 800-190: Application Container Security Guide - 3.1.5</a></p>
</div>
</li>
<li>
<p>Commit your configuration changes:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span>cd /home/ec2-user/environment/container-devsecops-wksp-config
git add .
git commit -m &quot;Added a trusted registry to hadolint configuration.&quot;
git push -u origin master
</pre></div>


<p>The next two defects can be fixed by modifying the Dockerfile.</p>
<ol>
<li>
<p>In the left file tree, expand the <strong>sample-application</strong> folder and open <strong>Dockerfile</strong>.</p>
</li>
<li>
<p>Fix the defects:</p>
<div class="admonition info">
<p class="admonition-title"><strong>DL3002</strong>: Last USER should not be root.</p>
<p><strong>Description</strong>: To adhere the principals of least privileges, your containers should not be running as root.  Most containerized processes are application services and therefore don’t require root access. </p>
<p><strong>Fix</strong>: Pin the version explicitly to a release tag.  Add the following to the Dockerfile:</p>
<p><code>RUN addgroup -S sasquatch</code></p>
<p><code>RUN adduser -S sasquatch -G sasquatch</code></p>
<p>Next, replace <code>USER root</code> with <code>USER sasquatch</code></p>
<p><strong>Explanation</strong>: By creating a user in your Dockerfile, you are making it not only secure by default but also easier to keep secure.</p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST 800-190: Application Container Security Guide - 3.1.2</a></p>
</div>
<div class="admonition info">
<p class="admonition-title"><strong>DL3007</strong>: Using latest is prone to errors if the image will ever update.</p>
<p><strong>Description</strong>: Latest is just a tag you add to an image and is no way dynamic.  It can be overwritten and prove difficult to understand what version of the software is installed.  Using the latest tag can effect the availability of your application and you should look at using a more explicit tag. </p>
<p><strong>Fix</strong>: Pin the version explicitly to a release tag.  </p>
<p>Replace <code>FROM python:latest</code> with <code>FROM python:alpine3.7</code></p>
<p><strong>Reference</strong>: <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf" target="_blank">NIST 800-190: Application Container Security Guide - 3.1.2</a></p>
</div>
</li>
<li>
<p>Commit your application source code changes:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span>cd /home/ec2-user/environment/sample-application
git add Dockerfile
git commit -m &quot;Fixed Dockerfile linting issues.&quot;
git push -u origin development
</pre></div>


<p><strong>View the Pull Request Feedback</strong></p>
<p>Updating the Pull Request branch automatically triggers the pipeline again.  You can view the feedback to see if the defects were remediated.</p>
<ol>
<li>Go to the <a href="https://us-east-2.console.aws.amazon.com/codesuite/codecommit/repositories/container-devsecops-wksp-app/pull-requests?region=us-east-2&status=OPEN" target="_blank">CodeCommit console</a></li>
<li>Click on the latest Pull Request.</li>
<li>Click the <strong>Activity</strong> tab to view the feedback.</li>
</ol>
<h2 id="stage-2-remove-secrets">Stage 2: Remove secrets</h2>
<p>Based on the feedback you received in the Pull request you can see that secrets were identified in your code.  </p>
<ol>
<li>
<p>Click on <strong>Logs</strong> in the comment or view the CodeBuild Project history to identify the secret and the file it is located in.</p>
<div class="admonition question">
<p class="admonition-title">How could you improve the feedback loop to make it easier for the developer?</p>
</div>
</li>
</ol>
<p><strong>Modify trufflehog configuration</strong></p>
<p>Currently your trufflehog configuration is scanning through all of your commits to identify secrets. Since you'll be removing any current secrets you can modify the configuration to only scan new commits to speed up the build.</p>
<ol>
<li>
<p>In the left file tree, expand the <strong>container-devsecops-wksp-config</strong> folder and open <strong>secrets_config.yml</strong>.</p>
</li>
<li>
<p>Update your trufflehog configuration to only scan 1 commit deep.</p>
</li>
</ol>
<p>Change this command:</p>
<div class="codehilite"><pre><span></span>- trufflehog --regex --rules secrets_config.json --entropy=False &quot;$APP_REPO_URL&quot;
</pre></div>


<p>To this:</p>
<div class="codehilite"><pre><span></span>- trufflehog --regex --rules secrets_config.json --entropy=False --max_depth 1 &quot;$APP_REPO_URL&quot;
</pre></div>


<div class="admonition info">
<p class="admonition-title">The second line adds "--max-depth 1" which limits the scan depth.</p>
</div>
<ol>
<li>Commit your configuration changes:</li>
</ol>
<div class="codehilite"><pre><span></span>cd /home/ec2-user/environment/container-devsecops-wksp-config
git add .
git commit -m &quot;Added a trusted registry to hadolint configuration.&quot;
git push -u origin master
</pre></div>


<p><strong> Remove secrets</strong></p>
<ol>
<li>Remove the secret from the file.</li>
<li></li>
<li>Modify build spec to only scan a max depth of 1 commit (Removing secrets from previous commits and revoking any credentials are best practices but are not in scope due to time constraints.)</li>
<li>Commit your changes</li>
</ol>
<h2 id="stage-3-vulnerability-scanning-stage">Stage 3: Vulnerability Scanning Stage</h2>
<hr />
<p>Congratulations!  You've completed the <strong>Integrating security into your container pipeline</strong> workshop. You can proceed to the next module to clean up the resources in your account.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../03-vuln-scanning/" title="Module 3: Vulnerability Scanning" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 3: Vulnerability Scanning
              </span>
            </div>
          </a>
        
        
          <a href="../05-cleanup/" title="Module 5: Cleanup" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 5: Cleanup
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>